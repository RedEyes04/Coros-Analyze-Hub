name: Deploy COROS Token & Fetch Data

on:
  push:
    paths:
      - coros-activities-scraper/token.txt
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: Sync token & fetch script to server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            coros-activities-scraper/token.txt \
            coros-activities-scraper/fetch.py \
            root@${{ secrets.SERVER_HOST }}:/www/wwwroot/coros.redeyes.top/

      - name: Run fetch on server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -T \
            -o StrictHostKeyChecking=no \
            root@${{ secrets.SERVER_HOST }} \
            "cd /www/wwwroot/coros.redeyes.top && python3 fetch.py && ls -lh activities_data.json"
