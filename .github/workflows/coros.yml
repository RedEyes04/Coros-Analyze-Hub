name: Sync COROS Cookies & Fetch Data

on:
  push:
    paths:
      - coros-activities-scraper/cookies.json
  workflow_dispatch:

jobs:
  fetch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      - name: Sync cookies & fetch script to server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            coros-activities-scraper/cookies.json \
            coros-activities-scraper/fetch.py \
            root@${{ secrets.SERVER_HOST }}:/www/wwwroot/coros.redeyes.top/

      - name: Run fetch on server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -T \
            -o StrictHostKeyChecking=no \
            root@${{ secrets.SERVER_HOST }} \
            "cd /www/wwwroot/coros.redeyes.top && python3 fetch.py"

      - name: Download data from server
        run: |
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            root@${{ secrets.SERVER_HOST }}:/www/wwwroot/coros.redeyes.top/activities_data.json \
            public/

      - name: Commit and push data
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          if git diff --quiet public/activities_data.json 2>/dev/null; then
            echo "ğŸ“ æ•°æ®æ— å˜åŒ–"
          else
            git add public/activities_data.json
            git commit -m "chore: update activities data [skip ci]"
            git push
            echo "âœ… æ•°æ®å·²æ›´æ–°å¹¶æ¨é€"
          fi
