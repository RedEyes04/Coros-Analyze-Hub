# COROS 数据自动抓取 Workflow
#
# 触发条件：token.txt 文件更新时
# 功能：
#   1. 同步 token 到服务器
#   2. 在服务器执行抓取脚本
#   3. 抓取结果复制一份到站点根目录（便于直接访问）
#   4. 将 public 下的数据回流仓库
#
# 需要配置的 Secrets：
#   - SERVER_HOST
#   - SERVER_PASSWORD

name: Sync & Fetch COROS Data

on:
  push:
    branches:
      - main
    paths:
      - 'coros-activities-scraper/token.txt'
  workflow_dispatch:

concurrency:
  group: coros-fetch
  cancel-in-progress: true

jobs:
  sync-and-fetch:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出仓库
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. 安装依赖
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync

      # 3. 同步 token 文件到服务器
      - name: Sync token file to server
        run: |
          echo "Syncing token.txt to server..."
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./coros-activities-scraper/token.txt \
            root@${{ secrets.SERVER_HOST }}:/www/wwwroot/coros.redeyes.top/coros-activities-scraper/

      # 4. 服务器执行抓取脚本，并复制结果到站点根目录
      - name: Run fetch script on server
        run: |
          echo "Running fetch script on server..."
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e

            BASE_DIR=/www/wwwroot/coros.redeyes.top
            SCRAPER_DIR=$BASE_DIR/coros-activities-scraper
            SRC_FILE=$BASE_DIR/public/activities_data.json
            DEST_FILE=$BASE_DIR/activities_data.json

            cd $SCRAPER_DIR

            # 激活虚拟环境（如存在）
            if [ -f "venv/bin/activate" ]; then
              source venv/bin/activate
            fi

            echo "Fetching COROS activities..."
            python3 fetch-with-token.py --pages 3

            # 校验抓取结果
            if [ ! -s "$SRC_FILE" ]; then
              echo "ERROR: activities_data.json not generated or empty"
              exit 1
            fi

            # 复制一份到站点根目录，供公网访问
            cp -f "$SRC_FILE" "$DEST_FILE"

            echo "Fetch & copy completed:"
            ls -lh "$SRC_FILE" "$DEST_FILE"
          EOF

      # 5. 从服务器拉取更新后的数据回仓库
      - name: Fetch updated data from server
        run: |
          echo "Fetching activities_data.json from server..."
          sshpass -p "${{ secrets.SERVER_PASSWORD }}" rsync -avz \
            -e "ssh -o StrictHostKeyChecking=no" \
            root@${{ secrets.SERVER_HOST }}:/www/wwwroot/coros.redeyes.top/public/activities_data.json \
            ./public/activities_data.json

      # 6. 提交并推送更新的数据
      - name: Commit and push updated data
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          if git diff --quiet public/activities_data.json; then
            echo "No changes to commit"
          else
            git add public/activities_data.json
            git commit -m "chore: update COROS activities data [skip ci]"
            git push
          fi